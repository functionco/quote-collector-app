/// <reference types="vite/client" />

import { DriveFile, GmailMessage, GmailAttachment, Source } from '../types';

let googleAuth: any;

const SCOPES = 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/gmail.readonly';

export const initGoogleClient = (onSuccess: (auth: any) => void, onError: (error: any) => void) => {
  const CLIENT_ID = import.meta.env.VITE_GOOGLE_CLIENT_ID;
  const API_KEY = import.meta.env.VITE_GOOGLE_API_KEY;

  if (!CLIENT_ID || !API_KEY) {
     onError("Google credentials (VITE_GOOGLE_CLIENT_ID and VITE_GOOGLE_API_KEY) are not configured as environment variables.");
     return;
  }
  
  window.gapi.load('client:auth2', () => {
    window.gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      scope: SCOPES,
      discoveryDocs: [
        "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
        "https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest",
      ],
    }).then(() => {
      googleAuth = window.gapi.auth2.getAuthInstance();
      onSuccess(googleAuth);
    }).catch(onError);
  });
};

export const signIn = () => {
  return googleAuth.signIn();
};

export const signOut = () => {
  googleAuth.signOut();
};

export const scanDrive = async (): Promise<DriveFile[]> => {
  const response = await window.gapi.client.drive.files.list({
    q: "(name contains 'quote' or fullText contains 'quote') and trashed = false",
    fields: 'files(id, name, mimeType, modifiedTime, webViewLink)',
    pageSize: 20,
  });
  return response.result.files || [];
};

export const scanGmail = async (): Promise<GmailMessage[]> => {
  const response = await window.gapi.client.gmail.users.messages.list({
    userId: 'me',
    q: 'has:attachment (subject:quote OR "quote" OR filename:quote)',
    maxResults: 20,
  });

  const messageIds = response.result.messages?.map(m => m.id!) ?? [];
  if (messageIds.length === 0) return [];

  const batch = window.gapi.client.newBatch();
  messageIds.forEach(id => {
    batch.add(window.gapi.client.gmail.users.messages.get({ userId: 'me', id, format: 'metadata' }));
  });

  const batchResponse = await batch;
  const messages: GmailMessage[] = [];

  for (const messageId of messageIds) {
      const messageResponse = batchResponse.result[messageId];
      if (!messageResponse || messageResponse.status !== 200) continue;
      
      const msg = messageResponse.result;
      const headers = msg.payload?.headers || [];
      const subject = headers.find(h => h.name === 'Subject')?.value || 'No Subject';
      const from = headers.find(h => h.name === 'From')?.value || 'Unknown Sender';
      const date = headers.find(h => h.name === 'Date')?.value || new Date().toISOString();

      if (msg.payload?.parts) {
        const attachments: GmailAttachment[] = msg.payload.parts
          .filter(part => part.filename && part.body?.attachmentId)
          .map(part => ({
            id: part.body.attachmentId!,
            name: part.filename!,
            mimeType: part.mimeType!,
            size: part.body.size!,
          }));
        
        if (attachments.length > 0) {
            messages.push({
              id: msg.id!,
              snippet: msg.snippet!,
              subject,
              date,
              from,
              attachments,
            });
        }
      }
  }
  return messages;
};

const fileToBase64 = (file: Blob): Promise<string> =>
  new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => {
      const result = reader.result as string;
      resolve(result.split(',')[1]);
    };
    reader.onerror = reject;
  });

export const getFileContentAsBase64 = async (
    sourceType: Source, 
    ids: { fileId?: string, messageId?: string, attachmentId?: string }
): Promise<{mimeType: string, data: string}> => {
    if (sourceType === Source.DRIVE) {
        const fileId = ids.fileId!;
        const meta = await window.gapi.client.drive.files.get({ fileId, fields: 'mimeType' });
        const mimeType = meta.result.mimeType!;

        if (mimeType.includes('google-apps')) {
            const exportMimeType = 'application/pdf';
            const response = await window.gapi.client.drive.files.export({ fileId, mimeType: exportMimeType });
            const blob = new Blob([response.body], { type: exportMimeType });
            return { mimeType: exportMimeType, data: await fileToBase64(blob) };
        } else {
            const response = await window.gapi.client.drive.files.get({ fileId, alt: 'media' });
            const blob = new Blob([response.body], { type: mimeType });
            return { mimeType, data: await fileToBase64(blob) };
        }
    } else { // GMAIL
        const { messageId, attachmentId } = ids;
        const response = await window.gapi.client.gmail.users.messages.attachments.get({
            userId: 'me',
            messageId: messageId!,
            id: attachmentId!,
        });
        const meta = await window.gapi.client.gmail.users.messages.get({userId: 'me', id: messageId!});
        const attachmentInfo = meta.result.payload?.parts?.find(p => p.body?.attachmentId === attachmentId);
        
        const base64url = response.result.data!;
        const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
        return { mimeType: attachmentInfo?.mimeType || 'application/octet-stream', data: base64 };
    }
}